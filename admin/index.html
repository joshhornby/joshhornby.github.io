<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>

    <!-- Tell Decap where your config is -->
    <link rel="cms-config-url" href="config.yml" type="text/yaml" />

    <script>
        /* ------------------------------------------------------------------
           1)  Buffer any auth message that arrives before Decap CMS is ready.
        ------------------------------------------------------------------ */
        let bufferedAuthMsg = null;

        window.addEventListener('message', (event) => {
            if (typeof event.data === 'string' &&
                event.data.startsWith('authorization:github:success:')) {

                console.log('ðŸŸ¢  Auth message received:', event.data);

                // If CMS is already loaded, hand the message straight to it
                if (window.CMS && typeof window.CMS.handleAuth === 'function') {
                    window.CMS.handleAuth(event);
                    return;
                }

                // â€¦otherwise store it until CMS is ready
                bufferedAuthMsg = event;
            }
        });

        /* ------------------------------------------------------------------
           2)  Poll until Decap CMS is present, then replay the buffered message
        ------------------------------------------------------------------ */
        const cmsReadyInterval = setInterval(() => {
            if (window.CMS && typeof window.CMS.handleAuth === 'function') {
                console.log('âœ…  Decap CMS ready');
                clearInterval(cmsReadyInterval);

                if (bufferedAuthMsg) {
                    console.log('ðŸ”„  Replaying buffered auth message');
                    window.CMS.handleAuth(bufferedAuthMsg);
                    bufferedAuthMsg = null;
                }
            }
        }, 100);   // check every 100 ms
    </script>
</head>

<body>
<!-- Load Decap CMS v3 -->
<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
</body>
</html>
